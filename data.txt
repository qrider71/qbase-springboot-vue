#!/bin/bash

IMAGE_ID_FILE="image_id.tmp"

SUVA_EXTENSIONS_VERSION="0.0.2"
KEYCLOAK_CONFIG_CLI_VERSION="3.1.3.1"
PROMETHEUS_METRICS_VERSION="1.0.4"

rm resources/*.json
cp ../base/keycloak/resources/*.json resources/

./deleteDockerImage.sh
docker build . --build-arg SUVA_EXTENSIONS_VERSION=$SUVA_EXTENSIONS_VERSION --build-arg KEYCLOAK_CONFIG_CLI_VERSION=$KEYCLOAK_CONFIG_CLI_VERSION | tee docker.log
cat docker.log | grep 'Successfully built' | awk -F " " '{print $3}' > $IMAGE_ID_FILE

-- ende build

#!/bin/bash

IMAGE_ID_FILE="image_id.tmp"

if test -f "$IMAGE_ID_FILE"; then
    echo "$IMAGE_ID_FILE exists"
    IMAGE_ID=`cat $IMAGE_ID_FILE`
    echo "docker image id is $IMAGE_ID"

    docker ps -a|grep $IMAGE_ID | \
    while read line; do \
      CONTAINER_ID=`echo $line | awk -F " " '{print $1}'`;\
      echo "Stop conainer with ID=$CONTAINER_ID"; \
      docker container stop $CONTAINER_ID; \
      echo "Delete conainer with ID=$CONTAINER_ID"; \
      docker container rm $CONTAINER_ID; \
    done

    echo "Delete docker image with ID=$IMAGE_ID"
    docker image rm $IMAGE_ID

    rm $IMAGE_ID_FILE
fi

-- ende delete

#!/bin/bash

IMAGE_ID_FILE="image_id.tmp"

echo "Starting docker image ..."

if test -f "$IMAGE_ID_FILE"; then
    echo "$IMAGE_ID_FILE exists"
    IMAGE_ID=`cat $IMAGE_ID_FILE`
    echo "docker image id is $IMAGE_ID"

    docker ps -a|grep $IMAGE_ID | \
    while read line; do \
      CONTAINER_ID=`echo $line | awk -F " " '{print $1}'`;\
      echo "Stop conainer with ID=$CONTAINER_ID"; \
      docker container stop $CONTAINER_ID; \
      echo "Delete conainer with ID=$CONTAINER_ID"; \
      docker container rm $CONTAINER_ID; \
    done

    echo "Run docker image with ID=$IMAGE_ID"
    docker run -p 8080:8080 -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=admin $IMAGE_ID
  else
    echo "No docker image found - run ./buildDockerImage.sh before"
fi

-- ende run
